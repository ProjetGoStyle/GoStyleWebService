<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GoStyle</title>

    <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

</head>
<body>
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <button class="btn my-2 my-sm-0" id="logout">Logout</button>
</nav>
<div class="container">
    <div class="row pb-2">
        <form class="col-md-12" id="addForm">
            <div class="form-row">
                <div class="col-md-5">
                    <input type="text" name="promoCode" id="promoCodeInput" class="form-control" placeholder="Le code promo"
                           value=""/>
                </div>
                <div class="col-md-5">
                    <textarea name="description" id="descriptionInput" class="form-control" placeholder="La description du code promo"
                              value=""></textarea>
                </div>
                <div class="col-md-2">
                    <input type="submit" class="btnSubmit" name="add" value="Ajouter"/>
                </div>
            </div>
        </form>
    </div>
    <div class="row">
        <table class="table">
            <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Code Promo</th>
                <th scope="col">Description</th>
                <th scope="col">Suppression</th>
            </tr>
            </thead>
            <tbody id="promoCodes"></tbody>
        </table>
    </div>
</div>
<script>
    function createTableElement(id, promoCode, description) {
        const tr = document.createElement('tr');
        const rowNumber = document.createElement('th');
        rowNumber.setAttribute('scope', 'row');
        rowNumber.innerText = id;

        tr.appendChild(rowNumber);

        const codeElement = document.createElement('td');
        codeElement.innerText = promoCode;

        tr.appendChild(codeElement);

        const descElement = document.createElement('td');
        descElement.innerText = description;

        tr.appendChild(descElement);

        const deleteElement = document.createElement('td');

        const deleteButton = document.createElement('button');
        deleteButton.value = 'x';
        deleteButton.onclick = () => {
            const xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState === 4 && this.status === 200)
                    tr.parentNode.removeChild(tr);
            };
            xhttp.open('DELETE', 'api/coupon', true);
            const formData = new FormData();
            formData.append('id', id);
            xhttp.send(formData);
        };

        deleteElement.appendChild(deleteButton);

        tr.appendChild(deleteElement);

        return tr;
    }

    const promoCodeTable = document.querySelector('#promoCodes');
    const xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
        if (this.readyState === 4 && this.status === 200) {
            const promoCodes = JSON.parse(this.response);
            for (const code of promoCodes)
                promoCodeTable.appendChild(createTableElement(code.id, code.promoCode, code.description));
        }
    };
    xhttp.open('GET', 'api/coupons', true);
    xhttp.send();

    const promoCodeInput = document.querySelector('#promoCodeInput');
    const descriptionInput = document.querySelector('#descriptionInput');
    const addForm = document.querySelector('#addForm');
    addForm.onsubmit = (event) => {
        event.preventDefault();
        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200) {
                const code = JSON.parse(this.response);
                promoCodeTable.appendChild(createTableElement(code.id, code.promoCode, code.description));
            }
        };
        xhttp.open('GET', 'api/add', true);
        const formData = new FormData();
        formData.append('promoCode', promoCodeInput.innerHTML);
        formData.append('description', descriptionInput.innerHTML);
        xhttp.send(formData);
    };

    const logoutButton = document.querySelector('#logout');
    logoutButton.onclick = () => {
        const xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState === 4 && this.status === 200)
                window.location.replace('Login.html');
        };
        xhttp.open('GET', 'api/logout', true);
        xhttp.send();
    };

</script>
</body>
</html>